<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®æŸ¥è©¢ - é¦™é­šæœƒå“¡å°ˆç”¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* ========= å…±ç”¨æ¨£å¼ ========= */
    body {
      font-family: "Zen Maru Gothic", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #FFF6E7;
      padding: 24px;
      margin: 0;
      color: #333;
    }

    .wrap {
      max-width: 720px;
      margin: 0 auto;
      background: #FFFDF7;
      border-radius: 18px;
      padding: 20px 20px 24px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      box-sizing: border-box;
    }

    h1 {
      font-size: 24px;
      text-align: center;
      margin: 0 0 8px;
      letter-spacing: 1px;
    }

    h1 span {
      font-size: 26px;
    }

    .subtitle {
      font-size: 12px;
      text-align: center;
      color: #87613B;
      margin-bottom: 14px;
    }

    .status-text {
      font-size: 12px;
      color: #555;
      margin: 2px 0 10px;
      line-height: 1.5;
    }

    label {
      font-size: 14px;
      display: block;
      margin: 8px 0 4px;
    }

    /* ========= æœå°‹å€å¡Š ========= */
    .search-block {
      margin-bottom: 6px;
    }

    .search-row-select {
      margin-bottom: 6px;
    }

    .search-row-select select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #FFD6A0;
      padding: 10px 12px;
      background: #FFFDF8;
      font-size: 14px;
      box-sizing: border-box;
    }

    .search-inline {
      display: flex;
      width: 100%;
      box-sizing: border-box;
    }

    .search-inline input[type="text"] {
      flex: 1 1 auto;
      border-radius: 999px 0 0 999px;
      border: 1px solid #FFB96A;
      border-right: none;
      padding: 10px 12px;
      font-size: 14px;
      background: #FFFDF8;
      box-sizing: border-box;
    }

    .search-inline button {
      flex: 0 0 auto;
      border-radius: 0 999px 999px 0;
      border: 1px solid #FFB96A;
      background: #FFB763;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 3px 0 #E39A3C;
      margin: 0;
    }

    .search-inline button:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 #E39A3C;
    }

    .tip {
      font-size: 12px;
      color: #777;
      margin-top: 6px;
      line-height: 1.4;
    }

    .result {
      margin-top: 16px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
      margin: 16px 0 8px;
      color: #8B5E2C;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .section-title-icon {
      font-size: 14px;
    }

    .customer-box {
      background: #FFF4DA;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #FFD8A8;
      font-size: 14px;
      line-height: 1.7;
      margin-bottom: 4px;
      list-style: none;
    }

    .customer-box ul {
      margin: 0;
      padding-left: 18px;
    }

    .info-box {
      margin-top: 12px;
      font-size: 13px;
      background: #FFF0D8;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px dashed #FFBC75;
      color: #555;
      line-height: 1.5;
    }

    .empty {
      font-size: 14px;
      color: #999;
      text-align: center;
      margin-top: 12px;
    }

    /* ====== å•†å“å°çµï¼ˆç¸½ä»¶æ•¸ï¼‹ç¸½é‡‘é¡ï¼‰ ====== */
    .summary-box {
      font-size: 13px;
      background: #FFF4E0;
      border-radius: 10px;
      padding: 6px 10px;
      margin-bottom: 6px;
      color: #704214;
    }

    .summary-box b {
      font-weight: 700;
    }

    /* ====== ç¯©é¸å€ï¼ˆé¡¯ç¤ºå·²å®Œæˆå‹¾å‹¾ï¼‰ ====== */
    .filter-bar {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
      color: #555;
    }

    .filter-bar input[type="checkbox"] {
      margin-right: 4px;
      accent-color: #69DB7C;
    }

    /* ====== ç‹€æ…‹ legend ====== */
    .status-legend {
      margin-top: 10px;
      font-size: 12px;
      background: #FFFDF5;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px dashed #FFE0B2;
      color: #555;
    }

    .status-legend ul {
      margin: 6px 0 0;
      padding-left: 18px;
    }

    .status-legend li {
      margin-bottom: 3px;
      list-style: none;
    }

    .legend-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }

    .legend-dot-pending {
      background: #FFD8A8;
    }

    .legend-dot-processing {
      background: #FFC9C9;
    }

    .legend-dot-arrived {
      background: #91A7FF;
    }

    .legend-dot-done {
      background: #8CE99A;
    }

    /* ====== æ­·å²è¨‚å–®ï¼ˆä¾å‡ºè²¨æ—¥æœŸçµ±æ•´ï¼‰ ====== */
    .history-box {
      margin-top: 16px;
      font-size: 13px;
      background: #F5F0FF;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px dashed #B197FC;
      color: #4B3F72;
    }

    .history-title {
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .history-summary {
      margin-bottom: 6px;
    }

    .history-summary b {
      font-weight: 700;
    }

    .history-empty {
      font-size: 12px;
      color: #777;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 12px;
    }

    .history-table th,
    .history-table td {
      border-bottom: 1px solid #E5DBFF;
      padding: 4px 2px;
      text-align: left;
      vertical-align: top;
    }

    .history-table th:nth-child(1),
    .history-table td:nth-child(1) {
      width: 18%;
      white-space: nowrap;
    }

    .history-table th:nth-child(2),
    .history-table td:nth-child(2) {
      width: 62%;
    }

    .history-table th:nth-child(3),
    .history-table td:nth-child(3) {
      width: 20%;
      white-space: nowrap;
      text-align: right;
    }

    /* ===== å¡ç‰‡ï¼ˆå•†å“ï¼‰ ===== */
    .card {
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid #FFD7B0;
      background: #FFF7E6;
      font-size: 14px;
      box-sizing: border-box;
      overflow: hidden;
    }

    .card--pending {
      background: #FFF7E6;
      border-color: #FFD8A8;
    }

    .card--processing {
      background: #FFF3D9;
      border-color: #FFC078;
    }

    .card--arrived {
      background: #E8F4FF;
      border-color: #74C0FC;
    }

    .card--done {
      background: #E7FBEF;
      border-color: #69DB7C;
    }

    .card--default {
      background: #F8F9FA;
      border-color: #CED4DA;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      gap: 8px;
    }

    .card-main {
      flex: 1 1 auto;
      min-width: 0;
    }

    .card-title {
      font-weight: 700;
      margin-bottom: 2px;
      color: #7A4D1A;
      font-size: 15px;
    }

    .card-subline {
      font-size: 13px;
      color: #555;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .card-subline span {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .card-toggle-icon {
      font-size: 16px;
      flex: 0 0 auto;
      color: #996633;
      transform: translateY(1px);
    }

    .badge {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 4px;
      white-space: nowrap;
    }

    .badge--pending {
      background: #FFE8CC;
      color: #D9480F;
    }

    .badge--processing {
      background: #FFE3E3;
      color: #C92A2A;
    }

    .badge--arrived {
      background: #DCEFFF;
      color: #1C7ED6;
    }

    .badge--done {
      background: #D3F9D8;
      color: #2B8A3E;
    }

    .badge--default {
      background: #E9ECEF;
      color: #495057;
    }

    .card-body {
      margin-top: 8px;
      font-size: 13px;
      line-height: 1.6;
      display: none;
    }

    .card-body.open {
      display: block;
    }

    .card-body-row {
      margin-bottom: 3px;
    }

    .link-btn {
      display: inline-block;
      padding: 4px 9px;
      border-radius: 10px;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid #FFB963;
      background: #FFF;
      margin-top: 3px;
    }

    .link-btn:hover {
      background: #FFF3E0;
    }

    /* ========= æ‰‹æ©Ÿ RWD ========= */
    @media (max-width: 768px) {
      body {
        padding: 0;
        background: #FFF6E7;
      }

      .wrap {
        max-width: 100%;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        padding: 20px 14px 24px;
        min-height: 100vh;
      }

      h1 {
        font-size: 22px;
        padding-bottom: 4px;
        border-bottom: 1px solid #FFE1B7;
      }

      .subtitle {
        margin-top: 4px;
        margin-bottom: 14px;
      }

      .search-row-select select {
        font-size: 15px;
        padding: 11px 12px;
      }

      .search-inline input[type="text"] {
        font-size: 16px;
        padding: 12px 12px;
      }

      .search-inline button {
        font-size: 16px;
        padding: 12px 16px;
      }

      .card {
        font-size: 14px;
      }

      .card-title {
        font-size: 15px;
      }

      .info-box {
        font-size: 13px;
      }
    }
  </style>
</head>

<body>
<div class="search-block">
  <label>â‘  è«‹è¼¸å…¥æœƒå“¡ç·¨è™Ÿã€ä¿¡ç®±æˆ–å®¢äººåç¨±é—œéµå­—</label>

  <div class="search-inline">
    <input id="searchValue" type="text" placeholder="ä¾‹ï¼šA001ï¼aaa@example.comï¼é­šé­š">
    <button type="button" onclick="searchOrder()">æœå°‹</button>
  </div>

  <div class="tip">
    âœ³ æœƒåŒæ™‚å¾ã€Œæœƒå“¡ç·¨è™Ÿï¼å®¢äººåç¨±ï¼ä¿¡ç®±ã€ä¸­æŸ¥è©¢ã€‚<br>
    âœ³ å®¢äººåç¨±æ”¯æ´é—œéµå­—ï¼ˆä¾‹ï¼šè¼¸å…¥ã€Œé­šé­šã€æœƒæ‰¾åˆ°ã€Œé¦™é­šå¤§é˜ªä»£è³¼ğŸŸã€ï¼‰ã€‚<br>
  </div>
</div>

  <div class="result" id="result"></div>
</div>

<script>
let rows = [];
let headerKeys = [];

/* å›ºå®šæ¬„ä½åç¨±ï¼ˆç…§ä½ çš„ CSV / Notionï¼‰ */
const COL_EMAIL    = "ä¿¡ç®±";
const COL_MEMBER   = "æœƒå“¡ç·¨è™Ÿ";
const COL_LINE     = "LINEåç¨±";      // ç›®å‰åªæ˜¯ä¿ç•™ï¼Œä¸å†ç”¨ä¾†æœå°‹
const COL_CUSTOMER = "å®¢äººåç¨±";      // ä¸»è¦ç”¨ä¾†æœå°‹ï¼†é¡¯ç¤ºçš„åç¨±
const COL_ITEM     = "å•†å“åç¨±";
const COL_SPEC     = "æ¬¾å¼";
const COL_QTY      = "æ•¸é‡";
const COL_STATUS   = "ç‹€æ…‹";
const COL_PRICE    = "é‡‘é¡";          // é€™è£¡ç•¶ä½œã€Œå°å¹£é‡‘é¡ã€
const COL_URL      = "å•†å“ç¶²å€";
const COL_NOTE     = "å‚™è¨»";
const COL_DATE     = "æ›´æ–°æ—¥æœŸ";
const COL_SHIPDATE = "å‡ºè²¨æ—¥æœŸ";

const COL_WEIGHT   = "é‡é‡";          // g
const COL_INTL_FEE = "åœ‹éš›é‹è²»";      // é è¨ˆåœ‹éš›é‹è²»ï¼ˆå°å¹£ï¼‰
const COL_INTL_INC = "å«åœ‹éš›é‹è²»";

const COL_PAYMENT_STATUS = "ä»˜æ¬¾ç‹€æ…‹"; // æœªä»˜æ¬¾ / éƒ¨åˆ†ä»˜æ¬¾ / å·²å…¨é¡ä»˜æ¬¾
const COL_REMAIN_TWD     = "å‰©é¤˜é‡‘é¡"; // åªåœ¨éƒ¨åˆ†ä»˜æ¬¾æ™‚å¡«ï¼ˆå°å¹£ï¼‰

// ========== å°å·¥å…·ï¼šæ—¥æœŸ / æ•¸å­— / é‡é‡ ==========

function formatDateDisplay(str) {
  if (!str) return "";
  if (/\d{4}-\d{2}-\d{2}T/.test(str)) {
    const d = new Date(str);
    if (!isNaN(d)) {
      return d.toLocaleDateString("zh-TW", {
        timeZone: "Asia/Taipei",
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      }).replace(/\//g, "-");
    }
  }
  return str;
}

function formatTotalWeight(totalGram) {
  if (!totalGram || totalGram <= 0) return "â€”";
  return totalGram.toLocaleString("zh-TW") + " g";
}

function parsePriceNumber(t) {
  const n = parseFloat((t || "").replace(/[^\d.]/g, ""));
  return isNaN(n) ? null : n;
}

function parseQuantityNumber(t) {
  const n = parseFloat((t || "1").replace(/[^\d.]/g, ""));
  return isNaN(n) ? 1 : n;
}

function parseNumberSafe(t) {
  const n = parseFloat((t || "").replace(/[^\d.]/g, ""));
  return isNaN(n) ? null : n;
}

// ç‹€æ…‹â†’æ¨£å¼ keyï¼ˆå°æ‡‰ .card--pending / processing / arrived / doneï¼‰
function getStatusStyleKey(t) {
  const s = (t || "").toLowerCase();

  if (s.includes("å®Œæˆ") || s.includes("çµå–®") ||
      s.includes("å¯„å‡º") || s.includes("å·²å¯„") ||
      s.includes("å®Œäº†") || s.includes("å·²å‡ºè²¨") ||
      s.includes("å‡ºè²¨") || s.includes("å‡ºè·")) {
    return "done";
  }
  if (s.includes("åˆ°è²¨") || s.includes("å·²åˆ°") ||
      s.includes("æŠµå°") || s.includes("åˆ°ç€") || s.includes("åˆ°è‘—")) {
    return "arrived";
  }
  if (s.includes("è™•ç†") || s.includes("é€²è¡Œ") ||
      s.includes("è™•ç†ä¸­") || s.includes("ä¸‹å–®") ||
      s.includes("æº–å‚™") || s.includes("æº–å‚™ä¸­")) {
    return "processing";
  }
  if (s.includes("æœª") || s.includes("å¾…")) {
    return "pending";
  }
  return "default";
}

// è®€å– fishorder.csv
window.addEventListener("DOMContentLoaded", () => {
  const statusEl      = document.getElementById("loadStatus");
  const searchInputEl = document.getElementById("searchValue");

  // Enter ç›´æ¥æœå°‹
  searchInputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      searchOrder();
    }
  });

  fetch("fishorder.csv")
    .then(resp => {
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      return resp.text();
    })
    .then(text => {
      parseRawData(text);
      statusEl.textContent = `å·²è¼‰å…¥è¨‚å–®è³‡æ–™ï¼Œå…± ${rows.length} ç­†ã€‚`;
    })
    .catch(err => {
      console.error(err);
      statusEl.textContent = "âš  ç„¡æ³•è®€å–è¨‚å–®è³‡æ–™ï¼Œè«‹ç¢ºèª fishorder.csv æ˜¯å¦èˆ‡æœ¬é åœ¨åŒä¸€è³‡æ–™å¤¾ï¼Œä¸¦é€é http æ–¹å¼é–‹å•Ÿã€‚";
    });
});

// è§£æ CSV/TSV
function parseRawData(raw) {
  const cleaned = raw.trim();
  const lines = cleaned.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) {
    rows = [];
    headerKeys = [];
    return;
  }

  const first = lines[0];
  const sep = first.includes("\t") ? "\t" : ",";
  headerKeys = first.split(sep).map(h => h.trim());

  rows = lines.slice(1).map(line => {
    const cols = line.split(sep);
    const o = {};
    headerKeys.forEach((h, i) => o[h] = (cols[i] || "").trim());
    return o;
  });
}

function searchOrder() {
  const keyword = document.getElementById("searchValue").value.trim().toLowerCase();
  const out     = document.getElementById("result");
  out.innerHTML = "";

  if (!keyword) {
    alert("è«‹è¼¸å…¥æŸ¥è©¢å…§å®¹");
    return;
  }
  if (!rows.length) {
    out.innerHTML = '<div class="empty">å°šæœªè¼‰å…¥è³‡æ–™ï¼Œè«‹ç¢ºèª fishorder.csv æ˜¯å¦å­˜åœ¨ã€‚</div>';
    return;
  }

  const hasEmail         = headerKeys.includes(COL_EMAIL);
  const hasMember        = headerKeys.includes(COL_MEMBER);
  const hasCustomer      = headerKeys.includes(COL_CUSTOMER);
  const hasShipDate      = headerKeys.includes(COL_SHIPDATE);
  const hasDate          = headerKeys.includes(COL_DATE);
  const hasWeight        = headerKeys.includes(COL_WEIGHT);
  const hasIntlFee       = headerKeys.includes(COL_INTL_FEE);
  const hasIntlInc       = headerKeys.includes(COL_INTL_INC);
  const hasPaymentStatus = headerKeys.includes(COL_PAYMENT_STATUS);
  const hasRemainTwd     = headerKeys.includes(COL_REMAIN_TWD);

  if (!hasMember && !hasCustomer && !hasEmail) {
    out.innerHTML = `<div class="empty">è³‡æ–™ä¸­æ²’æœ‰ã€Œæœƒå“¡ç·¨è™Ÿï¼å®¢äººåç¨±ï¼ä¿¡ç®±ã€æ¬„ä½ï¼Œè«‹ç¢ºèª CSV æ¨™é¡Œã€‚</div>`;
    return;
  }

  // ğŸ” ä¸‰ç¨®ä¸€èµ·æŸ¥ï¼š
  // æœƒå“¡ç·¨è™Ÿï¼šå®Œå…¨ä¸€è‡´
  // ä¿¡ç®±ï¼šå®Œå…¨ä¸€è‡´
  // å®¢äººåç¨±ï¼šé—œéµå­—åŒ…å«
  const matches = rows.filter(r => {
    const memberVal   = hasMember   ? (r[COL_MEMBER]   || "").toLowerCase() : "";
    const customerVal = hasCustomer ? (r[COL_CUSTOMER] || "").toLowerCase() : "";
    const emailVal    = hasEmail    ? (r[COL_EMAIL]    || "").toLowerCase() : "";

    if (memberVal && memberVal === keyword) return true;
    if (emailVal && emailVal === keyword)   return true;
    if (customerVal && customerVal.includes(keyword)) return true;
    return false;
  });

  if (!matches.length) {
    out.innerHTML = '<div class="empty">æŸ¥ç„¡ç¬¦åˆçš„è¨‚å–®è³‡æ–™ï¼Œè«‹ç¢ºèªè¼¸å…¥å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚</div>';
    return;
  }

  let html = "";
  const firstRow = matches[0];

  // ========= å®¢äººè³‡è¨Š =========
  html += `<div class="section-title"><span class="section-title-icon">ğŸ‘¤</span> å®¢äººè³‡è¨Š</div>`;
  html += `<div class="customer-box"><ul>`;
  if (hasMember)   html += `<li>æœƒå“¡ç·¨è™Ÿï¼š${firstRow[COL_MEMBER]   || ""}</li>`;
  if (hasCustomer) html += `<li>å®¢äººåç¨±ï¼š${firstRow[COL_CUSTOMER] || ""}</li>`;
  if (hasEmail)    html += `<li>ä¿¡ç®±ï¼š${firstRow[COL_EMAIL]        || ""}</li>`;
  html += `</ul></div>`;

  // ========= å•†å“åˆ—è¡¨ & å°è¨ˆ =========
  const hasItem   = headerKeys.includes(COL_ITEM);
  const hasSpec   = headerKeys.includes(COL_SPEC);
  const hasQty    = headerKeys.includes(COL_QTY);
  const hasStatus = headerKeys.includes(COL_STATUS);
  const hasPrice  = headerKeys.includes(COL_PRICE);
  const hasUrl    = headerKeys.includes(COL_URL);
  const hasNote   = headerKeys.includes(COL_NOTE);

  // å°è¨ˆï¼ˆæœªå®Œæˆéƒ¨åˆ†ï¼‰
  let activeCount      = 0;
  let totalTwd         = 0;
  let totalWeightGram  = 0;
  let needPayTwd       = 0;

  matches.forEach(r => {
    const statusKey = hasStatus ? getStatusStyleKey(r[COL_STATUS]) : "default";
    const isDone    = (statusKey === "done");
    if (isDone) return;

    activeCount += 1;

    const qty = hasQty ? parseQuantityNumber(r[COL_QTY]) : 1;
    let unitPrice  = null;
    let orderTotal = 0;

    if (hasPrice) {
      const p = parsePriceNumber(r[COL_PRICE]);
      if (p !== null) {
        unitPrice  = p;
        orderTotal = p * qty;
        totalTwd  += orderTotal;
      }
    }

    if (hasWeight && r[COL_WEIGHT]) {
      const w = parseNumberSafe(r[COL_WEIGHT]);
      if (w !== null) totalWeightGram += w * qty;
    }

    // ä»˜æ¬¾ç‹€æ…‹ï¼šæœªä»˜æ¬¾ / éƒ¨åˆ†ä»˜æ¬¾ / å·²å…¨é¡ä»˜æ¬¾
    if (hasPaymentStatus && hasPrice) {
      const ps = (r[COL_PAYMENT_STATUS] || "").trim() || "æœªä»˜æ¬¾";
      if (ps === "éƒ¨åˆ†ä»˜æ¬¾" && hasRemainTwd) {
        const rem = parseNumberSafe(r[COL_REMAIN_TWD]);
        if (rem !== null) needPayTwd += rem;
      } else if (ps === "å·²å…¨é¡ä»˜æ¬¾") {
        // ä¸éœ€å†æ”¶æ¬¾
      } else {
        if (unitPrice !== null) {
          needPayTwd += unitPrice * qty;
        }
      }
    }
  });

  // è‹¥é‚„æ²’åŠ ä»˜æ¬¾æ¬„ä½ï¼Œå°±è¦–ç‚ºå…¨éƒ¨æœªä»˜æ¬¾
  if (!headerKeys.includes(COL_PAYMENT_STATUS) && hasPrice) {
    needPayTwd = totalTwd;
  }

  let summaryHtml = "";
  if (activeCount > 0) {
    const totalTwdText = "NT$ " + totalTwd.toLocaleString("zh-TW");
    const weightText   = totalWeightGram ? formatTotalWeight(totalWeightGram) : "";
    const needPayText  = "NT$ " + needPayTwd.toLocaleString("zh-TW");
    summaryHtml = `
      <div class="summary-box">
        ğŸ§¾ æœªå®Œæˆè¨‚å–® ${activeCount} ç­†ï½œç¸½é¡ <b>${totalTwdText}</b>${weightText ? \`ï½œç¸½é‡é‡ ${weightText}\` : ""}<br>
        <span style="display:inline-block;margin-top:4px;">[ é‚„éœ€æ”¶æ¬¾ <b>${needPayText}</b> ]</span>
      </div>
    `;
  } else {
    summaryHtml = `<div class="summary-box">ç›®å‰æ²’æœ‰æœªå®Œæˆçš„è¨‚å–®ï¼Œä»¥ä¸‹ç‚ºå·²å®Œæˆç´€éŒ„ã€‚</div>`;
  }

  // ========== æ²’æœ‰å•†å“æ¬„ä½ï¼šç°¡æ˜“é¡¯ç¤º ==========
  if (!hasItem && !hasSpec) {
    html += `<div class="section-title"><span class="section-title-icon">ğŸ“¦</span> å•†å“åˆ—è¡¨ï¼ˆç°¡æ˜“é¡¯ç¤ºï¼‰</div>`;
    html += summaryHtml;

    matches.forEach((r, idx) => {
      const stText = hasStatus ? (r[COL_STATUS] || "") : "";
      const stKey  = hasStatus ? getStatusStyleKey(stText) : "default";
      html += `<div class="card card--${stKey}" data-status="${stKey}">`;
      html += `
        <div class="card-header" onclick="toggleCardBody(this)">
          <div class="card-main">
            <div class="card-title">
              ç¬¬ ${idx + 1} ç­†è¨‚å–®
              ${hasStatus ? `<span class="badge badge--${stKey}">${stText}</span>` : ""}
            </div>
          </div>
          <div class="card-toggle-icon">âŒ„</div>
        </div>
      `;
      html += `<div class="card-body${idx === 0 ? " open" : ""}">`;
      headerKeys.forEach(k => {
        let v = r[k] || "";
        if (k === COL_DATE || k === COL_SHIPDATE) {
          v = formatDateDisplay(v);
        }
        html += `<div class="card-body-row">${k}ï¼š${v}</div>`;
      });
      html += `</div></div>`;
    });

    html += `
      <div class="info-box">
        ğŸ”” å¦‚å°è¨‚å–®é€²åº¦æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹å°‡æ­¤ç•«é¢æˆªåœ–ï¼Œä¸¦é€é LINE å®˜æ–¹å¸³è™Ÿèˆ‡æˆ‘å€‘è¯ç¹«ã€‚<br>
        ç›®å‰å› ç‚º CSV æ¨™é¡Œä¸­æ²’æœ‰ã€Œå•†å“åç¨± / æ¬¾å¼ã€æ¬„ä½ï¼Œæš«ä»¥åŸå§‹æ¬„ä½é¡¯ç¤ºã€‚
      </div>
    `;
    html += statusLegendHtml();
    out.innerHTML = html;
    return;
  }

  // ========== ä¸€èˆ¬ã€Œå•†å“åˆ—è¡¨ã€ç‰ˆæœ¬ ==========
  html += `<div class="section-title"><span class="section-title-icon">ğŸ“¦</span> å•†å“åˆ—è¡¨</div>`;
  html += summaryHtml;

  // ç‹€æ…‹ç¯©é¸ selectï¼ˆé è¨­ï¼šæœªå®Œæˆï¼‰
  html += `
    <div class="filter-bar">
      <label>ç‹€æ…‹ï¼š
        <select id="statusFilter">
          <option value="not-completed">æœªå®Œæˆï¼ˆé è¨­ï¼‰</option>
          <option value="all">å…¨éƒ¨</option>
          <option value="pending">æœªè™•ç† / å¾…ç¢ºèª</option>
          <option value="processing">è™•ç†ä¸­ / å·²ä¸‹å–®</option>
          <option value="arrived">å·²åˆ°è²¨ / å·²æŠµå°</option>
          <option value="done">å·²çµå–®</option>
        </select>
      </label>
    </div>
  `;

  // ä¾ å•†å“åç¨± + æ¬¾å¼ åˆ†çµ„
  const group = {};
  matches.forEach(r => {
    const itemVal = hasItem ? (r[COL_ITEM] || "") : "";
    const specVal = hasSpec ? (r[COL_SPEC] || "") : "";
    const key = itemVal + "||" + specVal;
    if (!group[key]) group[key] = [];
    group[key].push(r);
  });

  Object.keys(group).forEach((key, idx) => {
    const list = group[key];
    const last = list[list.length - 1];

    const itemVal = hasItem ? (list[0][COL_ITEM] || "") : "";
    const specVal = hasSpec ? (list[0][COL_SPEC] || "") : "";

    const qtyTotal = list
      .map(r => hasQty ? parseQuantityNumber(r[COL_QTY]) : 1)
      .reduce((a, b) => a + b, 0);

    const priceBase = hasPrice ? parsePriceNumber(list[0][COL_PRICE]) : null;
    const total = priceBase ? priceBase * qtyTotal : "";

    const noteCombined = hasNote
      ? [...new Set(list.map(r => r[COL_NOTE]).filter(Boolean))].join(" / ")
      : "";

    const statusText     = hasStatus ? (last[COL_STATUS] || "") : "";
    const statusKeyStyle = hasStatus ? getStatusStyleKey(statusText) : "default";

    html += `<div class="card card--${statusKeyStyle}" data-status="${statusKeyStyle}">`;

    // headerï¼šå•†å“åç¨± + å°å°ç‹€æ…‹æ¬„ï¼ˆbadgeï¼‰
    html += `
      <div class="card-header" onclick="toggleCardBody(this)">
        <div class="card-main">
          <div class="card-title">
            ${itemVal || "æœªå¡«å•†å“"}${specVal ? \`ï¼ˆ${specVal}ï¼‰\` : ""}
            ${hasStatus ? `<span class="badge badge--${statusKeyStyle}">${statusText}</span>` : ""}
          </div>
          <div class="card-subline">
            <span>æ•¸é‡ï¼š${qtyTotal}</span>
            ${
              hasPrice
                ? `<span>é‡‘é¡ï¼š${list[0][COL_PRICE] || ""}${total ? \`ï¼ˆåˆè¨ˆï¼š${total}ï¼‰\` : ""}</span>`
                : ""
            }
          </div>
        </div>
        <div class="card-toggle-icon">âŒ„</div>
      </div>
    `;

    // body
    html += `<div class="card-body${idx === 0 ? " open" : ""}">`;

    // ğŸ’° æ”¶æ¬¾ç‹€æ…‹ï¼ˆæœ‰æ¬„ä½å°±é¡¯ç¤ºï¼‰
    if (headerKeys.includes(COL_PAYMENT_STATUS)) {
      const psRaw = (last[COL_PAYMENT_STATUS] || "").trim();
      const ps = psRaw || "æœªä»˜æ¬¾";
      let line = "";
      if (ps === "æœªä»˜æ¬¾") {
        line = "ğŸ’° æ”¶æ¬¾ç‹€æ…‹ï¼šæœªä»˜æ¬¾";
      } else if (ps === "å·²å…¨é¡ä»˜æ¬¾") {
        line = "ğŸ’° æ”¶æ¬¾ç‹€æ…‹ï¼šå·²å…¨é¡ä»˜æ¬¾";
      } else if (ps === "éƒ¨åˆ†ä»˜æ¬¾") {
        let remainText = "";
        if (headerKeys.includes(COL_REMAIN_TWD)) {
          const rem = parseNumberSafe(last[COL_REMAIN_TWD]);
          if (rem !== null) {
            remainText = `ï¼ˆå‰©é¤˜ NT$ ${rem.toLocaleString("zh-TW")}ï¼‰`;
          }
        }
        line = "ğŸ’° æ”¶æ¬¾ç‹€æ…‹ï¼šéƒ¨åˆ†ä»˜æ¬¾ " + remainText;
      }
      html += `<div class="card-body-row">${line}</div>`;
    }

    // âš– é‡é‡ï¼š100g / é è¨ˆåœ‹éš›é‹è²»ï¼š$25
    let weightStr = "";
    let intlStr   = "";
    if (headerKeys.includes(COL_WEIGHT) && last[COL_WEIGHT]) {
      const w = parseNumberSafe(last[COL_WEIGHT]);
      weightStr = (w !== null) ? `${w}g` : `${last[COL_WEIGHT]}g`;
    }
    if (headerKeys.includes(COL_INTL_FEE) && last[COL_INTL_FEE]) {
      const fee = parseNumberSafe(last[COL_INTL_FEE]);
      intlStr = (fee !== null)
        ? `$${fee.toLocaleString("zh-TW")}`
        : `$${last[COL_INTL_FEE]}`;
    }
    if (weightStr || intlStr) {
      html += `<div class="card-body-row">âš– é‡é‡ï¼š${weightStr || "â€”"} / é è¨ˆåœ‹éš›é‹è²»ï¼š${intlStr || "â€”"}</div>`;
    }

    // âœ… é‡‘é¡å·²å«åœ‹éš›é‹è²»
    if (headerKeys.includes(COL_INTL_INC) && last[COL_INTL_INC]) {
      const v = (last[COL_INTL_INC] || "").toString().toLowerCase();
      const isIncluded = ["true","yes","1","æ˜¯","y"].some(t => v.includes(t));
      if (isIncluded) {
        html += `<div class="card-body-row">âœ… é‡‘é¡å·²å«åœ‹éš›é‹è²»</div>`;
      }
    }

    if (hasUrl && last[COL_URL]) {
      html += `<div class="card-body-row">ğŸ”— å•†å“é€£çµï¼š<a class="link-btn" href="${last[COL_URL]}" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹å•†å“é </a></div>`;
    }
    if (noteCombined) {
      html += `<div class="card-body-row">ğŸ“ å‚™è¨»ï¼š${noteCombined}</div>`;
    }
    if (hasShipDate && last[COL_SHIPDATE]) {
      html += `<div class="card-body-row">ğŸšš å‡ºè²¨æ—¥æœŸï¼š${formatDateDisplay(last[COL_SHIPDATE])}</div>`;
    }
    if (hasDate && last[COL_DATE]) {
      html += `<div class="card-body-row">ğŸ“… æ›´æ–°æ—¥æœŸï¼š${formatDateDisplay(last[COL_DATE])}</div>`;
    }
    html += `</div>`; // end body
    html += `</div>`; // end card
  });

  html += `
    <div class="info-box">
      ğŸ”” å¦‚å°è¨‚å–®é€²åº¦æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹å°‡æ­¤ç•«é¢æˆªåœ–ï¼Œä¸¦é€é LINE å®˜æ–¹å¸³è™Ÿèˆ‡æˆ‘å€‘è¯ç¹«ã€‚<br>
      æˆ‘å€‘æœƒä¾ç…§ç•«é¢ä¸­çš„ã€Œè¨‚å–®ç‹€æ…‹ã€èˆ‡ã€Œæ›´æ–°æ—¥æœŸ / å‡ºè²¨æ—¥æœŸã€ç‚ºæ‚¨ç¢ºèªæœ€æ–°æƒ…æ³ã€‚ğŸ™
    </div>
  `;

  // æ­·å²è¨‚å–®ï¼ˆä¾å‡ºè²¨æ—¥æœŸçµ±æ•´ï¼‰
  if (hasStatus && (hasShipDate || hasDate)) {
    const doneRows = matches.filter(r => getStatusStyleKey(r[COL_STATUS]) === "done");
    html += buildHistoryByDateSection(doneRows, hasItem, hasSpec, hasQty, hasPrice, hasShipDate, hasDate);
  }

  html += statusLegendHtml();
  out.innerHTML = html;

  // ç‹€æ…‹ç¯©é¸ï¼ˆå–ä»£ checkboxï¼‰
  setupStatusFilter();
}

function statusLegendHtml() {
  return `
    <div class="status-legend">
      <div>ğŸ“Œ ç‹€æ…‹èªªæ˜ï¼ˆçµ¦æ‚¨åƒè€ƒï¼‰</div>
      <ul>
        <li><span class="legend-dot legend-dot-pending"></span>ã€Œæœªè™•ç† / å¾…ç¢ºèªã€ï¼šå°šæœªè™•ç†æˆ–ç­‰å¾…ä¸­</li>
        <li><span class="legend-dot legend-dot-processing"></span>ã€Œè™•ç†ä¸­ / æº–å‚™ä¸­ / å·²ä¸‹å–®ã€ï¼šè¨‚å–®å·²åœ¨è™•ç†æµç¨‹ä¸­</li>
        <li><span class="legend-dot legend-dot-arrived"></span>ã€Œå·²åˆ°è²¨ / æŠµå°ã€ï¼šå•†å“å·²æŠµé”æ—¥æœ¬æˆ–å°ç£ï¼Œæº–å‚™å¾ŒçºŒå‡ºè²¨</li>
        <li><span class="legend-dot legend-dot-done"></span>ã€Œå·²å‡ºè²¨ / å·²å®Œæˆ / çµå–®ã€ï¼šæ­¤å•†å“å·²è™•ç†å®Œç•¢ï¼Œæœƒå‡ºç¾åœ¨æ­·å²è¨‚å–®ã€‚</li>
      </ul>
    </div>
  `;
}

function buildHistoryByDateSection(doneRows, hasItem, hasSpec, hasQty, hasPrice, hasShipDate, hasDate) {
  if (!doneRows || !doneRows.length) {
    return `
      <div class="history-box">
        <div class="history-title">ğŸ“˜ æ­·å²è¨‚å–®ï¼ˆå·²çµå–®ï¼‰</div>
        <div class="history-empty">ç›®å‰å°šç„¡å·²çµå–®çš„å•†å“ï¼Œå®Œæˆå‡ºè²¨å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡ã€‚</div>
      </div>
    `;
  }

  const dateGroup = {};
  doneRows.forEach(r => {
    let d = "æœªå¡«æ—¥æœŸ";
    if (hasShipDate && r[COL_SHIPDATE]) {
      d = formatDateDisplay(r[COL_SHIPDATE]);
    } else if (hasDate && r[COL_DATE]) {
      d = formatDateDisplay(r[COL_DATE]);
    }
    if (!dateGroup[d]) dateGroup[d] = [];
    dateGroup[d].push(r);
  });

  const dateKeys = Object.keys(dateGroup).sort();

  let totalDoneQty    = 0;
  let totalDoneAmount = 0;
  let rowsHtml        = "";

  dateKeys.forEach(dateStr => {
    const list = dateGroup[dateStr];

    const itemGroup = {};
    list.forEach(r => {
      const itemVal = hasItem ? (r[COL_ITEM] || "") : "";
      const specVal = hasSpec ? (r[COL_SPEC] || "") : "";
      const key = itemVal + "||" + specVal;
      if (!itemGroup[key]) {
        itemGroup[key] = {
          item: itemVal,
          spec: specVal,
          qty: 0,
          price: null
        };
      }
      const q = hasQty ? parseQuantityNumber(r[COL_QTY]) : 1;
      itemGroup[key].qty += q;

      if (hasPrice) {
        const p = parsePriceNumber(r[COL_PRICE]);
        if (p !== null) {
          itemGroup[key].price = p;
        }
      }
    });

    let dayTotal = 0;
    const itemLines = Object.values(itemGroup).map(info => {
      const labelItem = info.item || "æœªå¡«å•†å“";
      const labelSpec = info.spec ? `ï¼ˆ${info.spec}ï¼‰` : "";
      const label = `${labelItem}${labelSpec} x${info.qty}`;
      totalDoneQty += info.qty;

      if (hasPrice && info.price !== null) {
        const sub = info.price * info.qty;
        dayTotal += sub;
        return `${label}ï¼ˆå°è¨ˆ Â¥${sub.toLocaleString("ja-JP")}ï¼‰`;
      } else {
        return label;
      }
    });

    if (hasPrice) {
      totalDoneAmount += dayTotal;
    }

    rowsHtml += `
      <tr>
        <td>${dateStr}</td>
        <td>${itemLines.join(" / ")}</td>
        <td>${hasPrice && dayTotal ? `Â¥ ${dayTotal.toLocaleString("ja-JP")}` : ""}</td>
      </tr>
    `;
  });

  return `
    <div class="history-box">
      <div class="history-title">ğŸ“˜ æ­·å²è¨‚å–®ï¼ˆä¾å‡ºè²¨æ—¥æœŸçµ±æ•´ï¼‰</div>
      <div class="history-summary">
        å·²çµå–®å•†å“å…± <b>${totalDoneQty}</b> ä»¶${
          (totalDoneAmount && !isNaN(totalDoneAmount))
            ? `ï¼Œç´¯è¨ˆé‡‘é¡ç´„ <b>Â¥ ${totalDoneAmount.toLocaleString("ja-JP")}</b>`
            : ""
        }
      </div>
      <table class="history-table">
        <thead>
          <tr>
            <th>å‡ºè²¨æ—¥æœŸ</th>
            <th>å‡ºè²¨å•†å“</th>
            <th>ç•¶æ—¥å°è¨ˆ</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    </div>
  `;
}

// å±•é–‹ / æ”¶åˆå¡ç‰‡
function toggleCardBody(headerEl) {
  const body = headerEl.nextElementSibling;
  if (!body) return;
  body.classList.toggle("open");
}

// ç‹€æ…‹ç¯©é¸ï¼ˆå–ä»£ checkboxï¼‰ï¼šé è¨­é¡¯ç¤ºã€Œæœªå®Œæˆã€ã€‚
function setupStatusFilter() {
  const sel = document.getElementById("statusFilter");
  if (!sel) return;

  const apply = () => {
    const v = sel.value;
    const cards = document.querySelectorAll("#result .card");
    cards.forEach(c => {
      const s = c.getAttribute("data-status") || "default";
      let show = true;
      if (v === "all") {
        show = true;
      } else if (v === "not-completed") {
        show = (s !== "done");
      } else {
        show = (s === v);
      }
      c.style.display = show ? "" : "none";
    });
  };

  sel.addEventListener("change", apply);
  apply();
}
</script>

</body>
</html>
